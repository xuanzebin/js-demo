<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>肥宅快乐导航</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <header></header>
    <main style="background-image: url(./img/wallhaven-630087.jpg); background-color: grey;">
        <div class="mask"></div>
        <div class="wrapper" id="main">
            <div class="promptMessage" id="message">提示：该按键没有被编辑任何网址!!</div> 
        </div>
    </main>
    <footer></footer>
    <script>

        //初始化
        var hashA=init()
        var key=hashA['key']
        var hash=hashA['hash']
        //生成键盘
        generateKeyboard(hash,key)
        //监听用户
        listenToUser(hash)
        //以下为工具函数
        function generateKeyboard(hash,key) {
            for(var index=0;index < key['length'];index=index+1) {
                var div = tag('div',{className:'row'})
                main.appendChild(div)
                for(index2=0;index2 < key[index]['length'];index2=index2+1) {
                    var span = tag('span',{textContent:key[index][index2],className:'text'})
                    var button=createButton(key[index][index2])
                    var img=createImg(hash[key[index][index2]],button.id)
                    var kbd = tag('kbd',{id:key[index][index2]+key[index][index2]})
                    div.appendChild(kbd)
                    kbd.appendChild(span)
                    kbd.appendChild(button) 
                    kbd.appendChild(img)
                }
            }
        }

        function listenToUser(hash) {
            document.onkeypress = function(inputPress) {
                x = inputPress.key
                var website = hash[x]
                if (website != undefined) {
                    window.open('http://' + website,'_blank')
                } else {
                    document.getElementById(x+x).style = "background:white;box-shadow: 0px 0px 0px 1px white,0 0 0 2px white;margin-bottom:4px;vertical-align: bottom;"
                    message.style = "color:black;"
                    setTimeout('document.getElementById(x+x).style="background: linear-gradient(to bottom, #282828 0%,#111111 100%);box-shadow: 0px 0px 0px 1px #1A1B1C,0 0 0 2px #1F2020,0 3px 4px 2px #080808;"',100)
                    setTimeout('message.style="color:transparent;"',2000)
                }
            }
        }
        function init() {
            var key = { 
            '0':{0:'q',1:'w',2:'e',3:'r',4:'t',5:'y',6:'u',7:'i',8:'o',9:'p',length:10},
            '1':{0:'a',1:'s',2:'d',3:'f',4:'g',5:'h',6:'j',7:'k',8:'l',length:9},
            '2':{0:'z',1:'x',2:'c',3:'v',4:'b',5:'n',6:'m',length:7},
            'length':3
            }
            var hash = {
                'q':'qq.com',
                'w':'weibo.com',
                'y':'yys.163.com/',
                'x':'x5.qq.com/act/a20180424decennial/index.html?ADTAG=media.buy.baidukeyword.ppc_x5pc_u24337174.k85602435564.a22084836300',
                'd':'id5.163.com/baidu_mobile_pz/',
                'g':'www.gamersky.com/',
                's':'store.steampowered.com/',
                'b':'www.bh3.com/',
                'c':'csol.tiancity.com/homepage/v6/',
                'l':'lol.qq.com'
            }
            var hashInLocalStorage=getFromLocalStorage('web')
            if (hashInLocalStorage) {
                hash = hashInLocalStorage
            }
            return {
                'hash':hash,
                'key':key
            }
        }

        function getFromLocalStorage(name) {
            var hashInLocalStorage = JSON.parse(localStorage.getItem(name)||'null')
            return hashInLocalStorage
        }

        function tag(tagName,attributes) {
            var element = document.createElement(tagName)
            for (var key in attributes) {
                element[key]=attributes[key]
            }
            return element
        }

        function createImg(domain,idName) {
            var img = tag('img',{className:'ico',id:'img'+idName})
            if (domain) {
                img.src = "http://" + domain + "/favicon.ico"
            } else {
                img.src = "http://i.loli.net/2017/11/10/5a05afbc5e183.png"
            }
            img.onerror = function(error) {
                error.target.src = "http://i.loli.net/2017/11/10/5a05afbc5e183.png"
            }
            return img
        }
        

        function createButton(idName) {
            var button = tag('button',{id:idName,textContent:'编辑'})
            button.onclick = function(press) {
                var buttonPress = press.target
                var keys = buttonPress.id
                var websiteNew = prompt('请输入你要编辑的新网址：')
                hash[keys] = websiteNew
                localStorage.setItem('web',JSON.stringify(hash))
                if (hash[keys]) {
                    document.getElementById('img'+keys).src = "http://" + hash[keys] + "/favicon.ico"
                    img.onerror = function(error) {
                        error.target.src = "http://i.loli.net/2017/11/10/5a05afbc5e183.png"
                    }
                }
            }
            return button
        }

    </script>
</body>
</html>